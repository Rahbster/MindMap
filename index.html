<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3498db" />
    <title>MindMap Knowledge System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-192x192.png">
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body>
    <div id="sidenav" class="sidenav">
        <a href="javascript:void(0)" class="close-btn" id="close-menu-btn">&times;</a>
        <h2>Search Nodes</h2>
        <div class="search-container">
            <input type="search" id="node-search-input" placeholder="Search in current module...">
        </div>
        <div id="search-results-container">
            <!-- Search results will appear here -->
        </div>
        <hr>
        <div class="theme-toggle-container menu-item">
            <label class="toggle" for="theme-toggle-checkbox">
                <span class="toggle-label">Dark Mode</span>
                <input class="toggle-checkbox" type="checkbox" id="theme-toggle-checkbox">
                <div class="toggle-switch"></div>
            </label>
        </div>
        <h2>Load Module</h2>
        <div id="module-loader">
            <!-- Module links will be populated here -->
        </div>
        <hr>
        <button id="create-module-btn" class="menu-btn">Create New Module</button>
        <button id="open-link-modules-modal-btn" class="menu-btn">Link Modules</button>
        <hr>
        <button id="show-readme-btn" class="menu-btn">Help / About</button>
        <hr>
        <button id="open-reset-modal-btn" class="menu-btn destructive">Reset Application</button>
    </div>

    <div id="main-content">
        <header>
            <div class="header-content">
                <span class="hamburger-icon" id="open-menu-btn">&#9776;</span>
                <h1>MindMap: <span id="module-title"></span></h1>
                <nav id="breadcrumb-nav"></nav>
            </div>
        </header>

        <main class="container">
            <div class="mindmap-container">
                <div class="map-controls">
                    <button id="decrease-map-font-btn" class="icon-button" title="Decrease Map Size">A-</button>
                    <button id="increase-map-font-btn" class="icon-button" title="Increase Map Size">A+</button>
                    <button id="save-module-btn" class="icon-button" title="Save to File"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>
                    <button id="auto-organize-btn" class="icon-button" title="Auto Organize"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></button>
                </div>
                <h2>Knowledge Map</h2>
                <div id="mindmap-svg-container">
                    <!-- SVG Mind Map will be rendered here -->
                    <div id="welcome-message" class="welcome-message">
                        <h2>Welcome to the MindMap Knowledge System!</h2>
                        <p>To get started, open the side menu (â˜°) and click "Link Modules" to connect to a local or remote set of knowledge maps.</p>
                    </div>
                </div>
            </div>

            <div class="content-container">
                <div class="content-title-wrapper">
                    <!-- Wrapper for all buttons on the right -->
                    <div class="title-actions-wrapper">
                        <div class="font-controls">
                            <button id="decrease-font-btn" class="icon-button" title="Decrease font size">A-</button>
                            <button id="increase-font-btn" class="icon-button" title="Increase font size">A+</button>
                        </div>
                    </div>
                </div>
                <div id="content-display">
                    <!-- Content of the selected node will appear here -->
                    <p>Select a node from the map to view its content.</p>
                </div>

                <div id="quiz-container" class="hidden">
                    <h2>Mini-Quiz</h2>
                    <div id="score"></div>
                    <div id="quiz-question"></div>
                    <div id="quiz-options"></div>
                    <div id="quiz-feedback"></div>
                </div>
            </div>
        </main>

        <!-- Node Editor Modal -->
        <div id="node-editor-modal" class="modal hidden">
            <div class="modal-content">
                <h2>Edit Node</h2>
                <label for="node-title-input">Title</label>
                <input type="text" id="node-title-input" class="modal-input">
                <label for="node-content-editor">Content</label>
                <div id="node-content-editor"></div>
                <div class="modal-buttons">
                    <button id="save-node-btn" class="button-primary">Save</button>
                    <button id="cancel-node-edit-btn" class="button-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ReadMe Modal -->
    <div id="readme-modal" class="modal hidden">
        <div class="modal-content readme-content">
            <div class="readme-header">
                <h2>About This Application</h2>
                <div class="readme-search-container">
                    <input type="search" id="readme-search-input" placeholder="Search help...">
                    <span id="readme-search-count"></span>
                </div>
                <button id="close-readme-btn" class="icon-button">&times;</button>
            </div>
            <div id="readme-display">
                <!-- Rendered README.md will go here -->
            </div>
        </div>
    </div>

    <!-- Reset Application Modal -->
    <div id="reset-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>Reset Application</h2>
            <p>
                <strong>Preserve Config:</strong> Clears service workers and cache but keeps your saved settings (e.g., theme, font size).
            </p>
            <p>
                <strong>Full Reset:</strong> Clears ALL data including saved settings, service workers, and cache.
            </p>
            <p>
                <strong>Clear Linked Modules:</strong> Removes all user-linked modules and their cached content, but keeps settings.
            </p>
            <p>
                <strong>Clear Directory Handle:</strong> Forgets the permission to access a local folder. Use this if you have moved or deleted a linked folder.
            </p>
            <div class="modal-actions">
                <button id="reset-preserve-btn" class="button-primary">Preserve Config</button>
                <button id="reset-full-btn" class="button-danger">Full Reset</button>
                <button id="reset-clear-linked-btn" class="button-secondary">Clear Linked</button>
                <button id="reset-clear-handle-btn" class="button-secondary">Clear Handle</button>
                <button id="reset-cancel-btn" class="button-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Create Module Modal -->
    <div id="create-module-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>Create New Module</h2>
            <p>Create a new top-level mind map module. You will be prompted to select a directory to save the file in.</p>
            
            <label for="new-module-name-input">Module Name (e.g., "My New Project")</label>
            <input type="text" id="new-module-name-input" class="modal-input" placeholder="My New Project">
            
            <label for="new-module-filename-input">Filename (e.g., "my-project.json")</label>
            <input type="text" id="new-module-filename-input" class="modal-input" placeholder="my-project.json">

            <div class="modal-actions">
                <button id="create-module-save-btn" class="button-primary">Create and Save</button>
                <button id="create-module-cancel-btn" class="button-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Link Modules (from Manifest) Modal -->
    <div id="link-modules-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header-flex">
                <h2>Link Modules via Manifest</h2>
                <button id="toggle-link-mode-btn" class="button-secondary" data-mode="url">Switch to Local Folder</button>
            </div>

            <!-- URL Input Section (default) -->
            <div id="link-url-section">
                <p>Enter the base URL of a remote module repository. The app will download the <code>modules.json</code> manifest and all listed modules to a local folder you select.</p>
                <label for="manifest-url-input">Repository URL</label>
                <input type="url" id="manifest-url-input" class="modal-input" placeholder="https://rahbster.github.io/MindMap/modules/">
            </div>

            <!-- File Input Section (hidden by default) -->
            <div id="link-dir-section" class="hidden">
                <p>Select a local folder containing a <code>modules.json</code> manifest file. The app will discover all modules listed within it.</p>
            </div>

            <div class="modal-actions">
                <button id="link-confirm-btn" class="button-primary">Link</button>
                <button id="link-cancel-btn" class="button-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }
    </script>
    <!-- Quill Rich Text Editor -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script type="module" src="js/main.js"></script>
</body>
</html>